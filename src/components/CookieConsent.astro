---
/**
 * Cookie Consent Banner
 * Banner GDPR-compliant per acceptar/rebutjar cookies
 * Guarda preferència a localStorage
 */
import { siteConfig } from '../config/site';

const storageKey = siteConfig.cookies?.storageKey || 'cookie-consent-latorre2';
---

<div
  id="cookie-consent"
  class="cookie-banner"
  role="dialog"
  aria-labelledby="cookie-title"
  aria-describedby="cookie-desc"
  data-storage-key={storageKey}
>
  <div class="cookie-content">
    <div class="cookie-text">
      <p id="cookie-title" class="cookie-title">Utilitzem cookies</p>
      <p id="cookie-desc" class="cookie-desc">
        Utilitzem cookies per millorar la teva experiència i analitzar el tràfic del web.
      </p>
    </div>
    <div class="cookie-buttons">
      <button id="cookie-reject" class="cookie-btn cookie-btn-reject" type="button">
        Rebutjar
      </button>
      <button id="cookie-accept" class="cookie-btn cookie-btn-accept" type="button">
        Acceptar
      </button>
    </div>
  </div>
</div>

<style>
  .cookie-banner {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    z-index: 9998;
    background: var(--color-dark);
    color: var(--color-white);
    padding: 1rem;
    box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.3);
    transform: translateY(100%);
    transition: transform var(--transition-normal);
  }

  .cookie-banner.visible {
    transform: translateY(0);
  }

  .cookie-banner.hidden {
    display: none;
  }

  .cookie-content {
    max-width: var(--container-max);
    margin: 0 auto;
    display: flex;
    flex-direction: column;
    gap: 1rem;
    align-items: center;
  }

  @media (min-width: 768px) {
    .cookie-content {
      flex-direction: row;
      justify-content: space-between;
    }
  }

  .cookie-text {
    flex: 1;
    text-align: center;
  }

  @media (min-width: 768px) {
    .cookie-text {
      text-align: left;
    }
  }

  .cookie-title {
    font-family: var(--font-heading);
    font-size: 1rem;
    margin-bottom: 0.25rem;
  }

  .cookie-desc {
    font-size: 0.875rem;
    opacity: 0.9;
    margin: 0;
    line-height: 1.4;
  }

  .cookie-buttons {
    display: flex;
    gap: 0.75rem;
    flex-shrink: 0;
  }

  .cookie-btn {
    padding: 0.75rem 1.25rem;
    font-family: var(--font-body);
    font-size: 0.875rem;
    font-weight: 700;
    border: none;
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all var(--transition-fast);
  }

  .cookie-btn-reject {
    background: transparent;
    color: var(--color-white);
    border: 1px solid var(--color-white);
  }

  .cookie-btn-reject:hover {
    background: rgba(255, 255, 255, 0.1);
  }

  .cookie-btn-accept {
    background: var(--color-primary);
    color: var(--color-white);
  }

  .cookie-btn-accept:hover {
    background: var(--color-primary-dark);
    transform: translateY(-1px);
  }

  /* Espai per al FloatingCTA en mòbil */
  @media (max-width: 767px) {
    .cookie-banner {
      padding-bottom: calc(1rem + 80px);
    }
  }
</style>

<script>
  function initCookieConsent(): void {
    const banner = document.getElementById('cookie-consent');
    const acceptBtn = document.getElementById('cookie-accept');
    const rejectBtn = document.getElementById('cookie-reject');

    if (!banner) return;

    const storageKey = banner.dataset.storageKey || 'cookie-consent-latorre2';

    function getConsent(): string | null {
      return localStorage.getItem(storageKey);
    }

    function setConsent(status: 'accepted' | 'rejected'): void {
      localStorage.setItem(storageKey, status);
    }

    function hideBanner(): void {
      banner.classList.remove('visible');
      setTimeout(() => {
        banner.classList.add('hidden');
      }, 300);
    }

    function loadAnalytics(): void {
      window.dispatchEvent(new CustomEvent('cookie-consent-accepted'));
    }

    // Si ja hi ha decisió, no mostrar banner
    const consent = getConsent();
    if (consent) {
      banner.classList.add('hidden');
      if (consent === 'accepted') {
        loadAnalytics();
      }
      return;
    }

    // Mostrar banner amb animació (delay per no ser intrusiu)
    setTimeout(() => {
      banner.classList.add('visible');
    }, 1500);

    // Event handlers
    acceptBtn?.addEventListener('click', () => {
      setConsent('accepted');
      hideBanner();
      loadAnalytics();
    });

    rejectBtn?.addEventListener('click', () => {
      setConsent('rejected');
      hideBanner();
    });
  }

  // Inicialitzar quan el DOM estigui llest
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initCookieConsent);
  } else {
    initCookieConsent();
  }
</script>
